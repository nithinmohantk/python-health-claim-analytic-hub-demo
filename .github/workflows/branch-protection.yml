name: Branch Protection Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

jobs:
  validate-branch-name:
    name: Validate Branch Name
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check branch naming convention
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = context.payload.pull_request.head.ref;
            const validPatterns = [
              /^feature\/.+$/,
              /^bugfix\/.+$/,
              /^hotfix\/.+$/,
              /^release\/.+$/,
              /^docs\/.+$/,
              /^refactor\/.+$/,
              /^test\/.+$/,
            ];
            
            const isValid = validPatterns.some(pattern => pattern.test(branchName));
            
            if (!isValid && branchName !== 'develop') {
              core.setFailed(`Branch name "${branchName}" does not follow naming conventions. ` +
                `Expected format: feature/description, bugfix/description, hotfix/description, ` +
                `release/version, docs/description, refactor/description, or test/description`);
            } else {
              console.log(`✓ Branch name "${branchName}" follows naming conventions`);
            }

  check-pr-size:
    name: Check PR Size
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Calculate PR size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            let additions = 0;
            let deletions = 0;
            let changedFiles = files.length;
            
            files.forEach(file => {
              additions += file.additions;
              deletions += file.deletions;
            });
            
            const totalChanges = additions + deletions;
            
            console.log(`PR Statistics:`);
            console.log(`- Files changed: ${changedFiles}`);
            console.log(`- Additions: ${additions}`);
            console.log(`- Deletions: ${deletions}`);
            console.log(`- Total changes: ${totalChanges}`);
            
            // Warn for large PRs
            if (totalChanges > 1000) {
              core.warning(`⚠️ Large PR detected: ${totalChanges} changes across ${changedFiles} files. ` +
                `Consider splitting into smaller PRs for easier review.`);
            }
            
            if (changedFiles > 50) {
              core.warning(`⚠️ Many files changed: ${changedFiles} files. ` +
                `Consider splitting into smaller PRs.`);
            }

  check-commit-messages:
    name: Check Commit Messages
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate commit messages
        uses: actions/github-script@v7
        with:
          script: |
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const validPrefixes = ['Add:', 'Fix:', 'Update:', 'Refactor:', 'Docs:', 'Test:', 'Style:'];
            const invalidCommits = [];
            
            commits.forEach(commit => {
              const message = commit.commit.message.split('\n')[0]; // First line only
              const hasValidPrefix = validPrefixes.some(prefix => message.startsWith(prefix));
              
              if (!hasValidPrefix && !message.includes('[skip ci]')) {
                invalidCommits.push({
                  sha: commit.sha.substring(0, 7),
                  message: message,
                });
              }
            });
            
            if (invalidCommits.length > 0) {
              console.log('❌ Some commits do not follow the commit message convention:');
              invalidCommits.forEach(commit => {
                console.log(`  - ${commit.sha}: ${commit.message}`);
              });
              core.warning(`⚠️ ${invalidCommits.length} commit(s) do not follow the convention. ` +
                `Expected format: "Add:", "Fix:", "Update:", "Refactor:", "Docs:", "Test:", or "Style:"`);
            } else {
              console.log('✓ All commit messages follow the convention');
            }

  check-required-files:
    name: Check Required Files
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Check for required files
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const requiredFiles = [
              'README.md',
              'requirements.txt',
              '.gitignore',
            ];
            
            const missingFiles = [];
            
            requiredFiles.forEach(file => {
              if (!fs.existsSync(file)) {
                missingFiles.push(file);
              }
            });
            
            if (missingFiles.length > 0) {
              core.setFailed(`Missing required files: ${missingFiles.join(', ')}`);
            } else {
              console.log('✓ All required files present');
            }

  check-no-secrets:
    name: Check for Secrets
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Check for potential secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified

  enforce-pr-description:
    name: Enforce PR Description
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const minDescriptionLength = 50;
            
            if (!pr.body || pr.body.trim().length < minDescriptionLength) {
              core.setFailed(`PR description is too short (minimum ${minDescriptionLength} characters). ` +
                `Please provide a detailed description of your changes.`);
            } else {
              console.log('✓ PR description meets requirements');
            }
